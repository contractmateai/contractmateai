<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SignSense — Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- UI font (site UI can stay Inter). PDF uses Poppins via jsPDF loader below -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400&display=swap" rel="stylesheet" />
  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0e0c13; --card:#1c1b22; --border:#3b3b3b; --white:#ffffff; --muted:#bdbdbd;
      --green:#00ff65; --orange:#df911a; --red:#fe0000; --black:#000000;
      --radius:21px; --gap:18px; --sidebar:300px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--white);font:400 16px/1.7 Inter,system-ui,Segoe UI,Roboto,Arial}
    .layout{display:grid;grid-template-columns:var(--sidebar) 1fr;min-height:100vh}

    /* ===== SIDEBAR ===== */
    .sidebar{background:#0f0e14;border-right:1px solid var(--border);padding:12px 16px 16px;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;gap:16px}
    .brand{padding:0 2px 0 18px}
    .brand a{display:flex;align-items:center;gap:12px;height:52px;text-decoration:none;color:var(--white)}
    .brand img{width:34px;height:34px}
    .brand span{font-size:24px;color:var(--white);font-weight:400}
    .nav{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .nav a{text-decoration:none;color:var(--muted);display:flex;align-items:center;gap:16px;padding:16px 18px;border-radius:16px;border:1px solid transparent;transition:border-color .2s ease;font-size:19px;}
    .nav a img.icon{width:30px;height:30px;opacity:.95}
    .nav a img.arr{width:20px;height:20px;opacity:.9}
    .nav a.active{background:#181620;border:1px solid var(--border);color:var(--white)}
    .nav a:hover{background:transparent;border-color:var(--border);color:var(--white)}
    .nav a.active:hover{background:#181620;border-color:var(--border)}
    .push{flex:1}
    .end-only{display:none;opacity:0;transform:translateY(8px)}
    .legal,.copy,.copy2{color:var(--muted);font-size:15px;line-height:1.6}
    .footer-sep{height:1px;background:var(--border);margin:10px 0}

    /* ===== MAIN ===== */
    .main{padding:0 20px 140px;display:grid;grid-template-rows:auto auto 1fr;gap:12px}
    .topbar{position:sticky;top:0;z-index:5;background:var(--bg);display:flex;align-items:flex-end;justify-content:space-between;padding:8px 6px 10px;height:64px;border-bottom:1px solid var(--border)}
    .top-left{display:flex;align-items:center;gap:12px}
    .top-title{font-size:20px;color:var(--white);font-weight:400}

    .doc-title{display:flex;align-items:center;gap:8px;padding:2px 6px 0 6px}
    .doc-title .label{font-size:18px;color:var(--muted);font-weight:400}
    .doc-title .value{font-size:18px;color:var(--muted);font-weight:400}

    .lang{position:relative;padding:6px 4px}
    .lang-btn{display:flex;align-items:center;gap:8px;background:transparent;border:none;color:var(--white);font:400 20px/1 Inter;cursor:pointer;padding:6px 10px;min-width:40px;user-select:none}
    .lang-btn #langNow{letter-spacing:.6px}
    .lang-btn .caret{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid #fff;opacity:.9}
    .lang-menu{position:absolute;right:0;top:calc(100% + 8px);background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:240px;max-height:260px;overflow:auto;display:none;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:6px;scrollbar-width:thin;scrollbar-color:#6a6a6a transparent}
    .lang.open .lang-menu{display:block}
    .lang-menu::-webkit-scrollbar{width:6px}
    .lang-menu::-webkit-scrollbar-thumb{background:#6a6a6a;border-radius:10px}
    .lang-item{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;color:var(--white);cursor:pointer}
    .lang-item:hover{background:#17161e}

    .grid{display:grid;grid-template-columns:minmax(560px,1.25fr) minmax(560px,1fr);gap:var(--gap);align-items:start;margin-top:6px}
    .left,.right{display:flex;flex-direction:column;gap:var(--gap)}

    @keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fadeIn .8s ease forwards}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px 18px 20px;opacity:0;transform:translateY(8px)}
    .card h3{margin:0 0 16px;display:flex;align-items:center;gap:12px;font-size:24px;color:var(--white);font-weight:400}
    .card h3 img{width:30px;height:30px}

    .list{display:flex;flex-direction:column;gap:16px}
    .list p{margin:0;color:var(--muted);font-size:20px;overflow-wrap:anywhere;word-break:break-word}
    #summaryText:empty,#issuesList:empty,#suggestionsList:empty,#clausesList:empty{min-height:72px}
    #riskNote:empty,#clarNote:empty{min-height:24px}
    #scoreCard .score-remark:empty{min-height:40px}

    .bullets{margin:0;color:var(--muted);font-size:20px;padding-left:22px;list-style:disc}
    .bullets li{margin:0 0 12px}

    .numbered{counter-reset:item}
    .numbered p{position:relative;padding-left:26px}
    .numbered p::before{counter-increment:item;content:counter(item) ".";position:absolute;left:0;top:0;color:var(--muted)}

    .meter-block{display:flex;flex-direction:column;gap:10px}
    .meter-head{display:flex;align-items:center;justify-content:space-between}
    .meter-title{display:flex;align-items:center;gap:12px;font-size:22px}
    .meter-title img{width:32px;height:32px}
    .meter{height:10px;border-radius:999px;background:var(--black);overflow:hidden}
    .fill{height:100%;width:0%;transition:width 1.6s ease;border-radius:999px}

    .hcard{display:flex;gap:16px;align-items:center}
    .circle{width:160px;height:160px;position:relative;display:grid;place-items:center;flex:0 0 160px}
    .circle svg{transform:rotate(-90deg)}
    .circle .val{position:absolute;font-weight:400;font-size:34px;color:var(--white)}
    .circle circle.track{stroke:var(--black);stroke-width:12;fill:none}
    .circle circle.arc{stroke-width:12;fill:none;stroke-linecap:round;stroke-dasharray:440;stroke-dashoffset:440}
    .htext{flex:1;display:flex;flex-direction:column;gap:8px}
    .muted{color:var(--muted);font-size:18px}
    .status{display:flex;align-items:center;gap:8px;margin-top:8px}
    .status .dot{width:10px;height:10px;border-radius:2px;background:var(--green)}
    .status span{font-size:17px;color:var(--white);font-weight:400}

    #scoreCard{margin-top:12px}
    #confRightCard{margin-top:12px}
    #summaryCard,#riskCard,#clarCard,#profCard,#favCard,#deadCard,#issuesCard,#clausesCard,#suggestionsCard,#scoreCard,#confRightCard{will-change:transform,opacity}

    #scoreCard .score-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center}
    #scoreCard .score-pct{font-size:42px}
    .score-side{flex:1;display:flex;flex-direction:column;gap:14px}
    .score-remark{font-size:20px;color:var(--muted)}
    .score-bar{position:relative;height:22px;border-radius:14px;background:linear-gradient(90deg,#ff6b6b 0%, #ffd166 45%, #00e676 100%);border:1px solid #2f2f2f;box-shadow:inset 0 1px 0 rgba(255,255,255,.05);width:100%}
    .score-ind{position:absolute;top:-6px;height:34px;width:3px;background:#fff;border-radius:2px;box-shadow:0 0 8px rgba(255,255,255,.6)}
    .score-scale{display:flex;justify-content:space-between;font-size:16px;color:var(--muted)}

    .download-wrap{position:fixed;left:var(--sidebar);right:0;bottom:34px;display:none;justify-content:center;z-index:9;opacity:0;transform:translateY(8px)}
    .download{background:#f2f9fe;color:#000;border:1px solid #cfcfcf;border-radius:16px;padding:18px 32px;display:inline-flex;gap:12px;align-items:center;cursor:pointer;font-weight:400;font-size:19px;box-shadow:0 6px 28px rgba(0,0,0,.28)}
    .download:hover{filter:brightness(1.03)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:20}
    .modal-card{background:#141319;border:1px solid var(--border);border-radius:18px;padding:18px 18px 16px;width:min(480px,92vw)}
    .modal-card h4{margin:0 0 10px;font-size:18px;font-weight:400}
    .modal-row{display:flex;gap:10px;margin-top:12px}
    .input{flex:1;background:#0f0e14;border:1px solid #5a5a5a;border-radius:10px;padding:12px;color:#fff;font:400 15px/1 Inter}
    .btn{background:#0f0e14;border:1px solid var(--border);color:#fff;border-radius:10px;padding:12px 14px;cursor:pointer}
    .btn.primary{background:#f2f9fe;color:#000;border-color:#cfcfcf}

    @media (max-width:1100px){
      .layout{grid-template-columns:1fr}
      .download-wrap{left:0}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar">
      <div class="brand">
        <a href="index.html" aria-label="Go to homepage">
          <img src="https://imgur.com/Z5hv7K9.png" alt="SignSense logo">
          <span>SignSense</span>
        </a>
      </div>

      <nav class="nav">
        <a class="active" href="#"><img class="arr" src="https://imgur.com/CHGomYz.png" alt=""><img class="icon" src="https://imgur.com/lnQTDuo.png" alt=""><span>Overview</span></a>
        <a href="index.html"><img class="arr" src="https://imgur.com/xhkeG0y.png" alt=""><img class="icon" src="https://imgur.com/kE3okdE.png" alt=""><span>Home</span></a>
        <a href="privacy.html"><img class="arr" src="https://imgur.com/xhkeG0y.png" alt=""><img class="icon" src="https://imgur.com/krMnFVT.png" alt=""><span>Privacy</span></a>
        <a href="#"><img class="arr" src="https://imgur.com/xhkeG0y.png" alt=""><img class="icon" src="https://imgur.com/6zHviT6.png" alt=""><span>Contact Us</span></a>
        <a href="#" id="leaveReview"><img class="arr" src="https://imgur.com/xhkeG0y.png" alt=""><img class="icon" src="https://imgur.com/zwr9SOe.png" alt=""><span>Leave a Review</span></a>
      </nav>

      <div class="push"></div>
      <div class="end-only" id="sidebarEnd">
        <div class="legal">All rights reserved.</div>
        <div class="copy2">© 2025 SignSense</div>
        <div class="footer-sep"></div>
        <div class="copy">Not legal advice.<br/>For informational use only.</div>
      </div>
    </aside>

    <!-- ===== MAIN ===== -->
    <main class="main">
      <div class="topbar">
        <div class="top-left"><div class="top-title" id="uiOverview">Overview</div></div>
        <div class="lang" id="lang">
          <button class="lang-btn" id="langBtn" type="button">
            <span id="langNow">EN</span><span class="caret" aria-hidden="true"></span>
          </button>
          <div class="lang-menu" id="langMenu" role="listbox" aria-label="Report Language">
            <div class="lang-item" data-code="en">English</div>
            <div class="lang-item" data-code="it">Italiano</div>
            <div class="lang-item" data-code="de">Deutsch</div>
            <div class="lang-item" data-code="es">Español</div>
            <div class="lang-item" data-code="fr">Français</div>
            <div class="lang-item" data-code="pt">Português</div>
            <div class="lang-item" data-code="nl">Nederlands</div>
            <div class="lang-item" data-code="ro">Română</div>
            <div class="lang-item" data-code="sq">Shqip</div>
            <div class="lang-item" data-code="tr">Türkçe</div>
            <div class="lang-item" data-code="zh">中文</div>
            <div class="lang-item" data-code="ja">日本語</div>
          </div>
        </div>
      </div>

      <!-- Contract title row -->
      <div class="doc-title">
        <span class="label" id="uiTitleLabel">Title:</span>
        <span class="value" id="uiTitleValue">—</span>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <div class="left">
          <section class="card" id="summaryCard">
            <h3><img src="https://imgur.com/CuQFbD7.png" alt=""><span id="uiSummary">Summary</span></h3>
            <div class="list" id="summaryText"></div>
          </section>

          <section class="card meter-block" id="profCard">
            <div class="meter-head">
              <div class="meter-title"><img src="https://imgur.com/EdMAMnx.png" alt=""> <span id="uiProfessionalism">Professionalism</span></div>
              <div id="confVal">0%</div>
            </div>
            <div class="meter"><div id="confFill" class="fill"></div></div>
          </section>

          <section class="card meter-block" id="favCard">
            <div class="meter-head">
              <div class="meter-title"><img src="https://imgur.com/UDRuIvO.png" alt=""> <span id="uiFavorability">Favorability Index</span></div>
              <div id="favVal">0%</div>
            </div>
            <div class="meter"><div id="favFill" class="fill"></div></div>
          </section>

          <section class="card meter-block" id="deadCard">
            <div class="meter-head">
              <div class="meter-title"><img src="https://imgur.com/VXZ3kD8.png" alt=""> <span id="uiDeadline">Deadline pressure</span></div>
              <div id="deadVal">0%</div>
            </div>
            <div class="meter"><div id="deadFill" class="fill"></div></div>
          </section>

          <section class="card" id="issuesCard">
            <h3><img src="https://imgur.com/ppLDtiq.png" alt=""><span id="uiIssues">Potential Issues</span></h3>
            <ul class="bullets" id="issuesList"></ul>
          </section>

          <section class="card" id="suggestionsCard">
            <h3><img src="https://imgur.com/EoVDfd5.png" alt=""><span id="uiSuggestions">Smart Suggestions</span></h3>
            <div class="list numbered" id="suggestionsList"></div>
          </section>
        </div>

        <!-- RIGHT -->
        <div class="right">
          <section class="card" id="riskCard">
            <div class="hcard">
              <div class="circle">
                <svg width="160" height="160" viewBox="0 0 160 160">
                  <circle class="track" cx="80" cy="80" r="74"></circle>
                  <circle id="riskArc" class="arc" cx="80" cy="80" r="74"></circle>
                </svg>
                <div class="val" id="riskVal">0%</div>
              </div>
              <div class="htext">
                <h3 style="margin-bottom:0"><img src="https://imgur.com/Myp6Un4.png" alt=""><span id="uiRisk">Risk Level</span></h3>
                <div class="muted" id="riskNote"></div>
                <div class="status"><span class="dot" id="riskDot"></span><span id="riskBadge">Generally Safe</span></div>
              </div>
            </div>
          </section>

          <section class="card" id="clarCard">
            <div class="hcard">
              <div class="circle">
                <svg width="160" height="160" viewBox="0 0 160 160">
                  <circle class="track" cx="80" cy="80" r="74"></circle>
                  <circle id="clarArc" class="arc" cx="80" cy="80" r="74"></circle>
                </svg>
                <div class="val" id="clarVal">0%</div>
              </div>
              <div class="htext">
                <h3 style="margin-bottom:0"><img src="https://imgur.com/o39xZtC.png" alt=""><span id="uiClarity">Clause Clarity</span></h3>
                <div class="muted" id="clarNote"></div>
                <div class="status"><span class="dot" id="clarDot"></span><span id="clarBadge">Generally Safe</span></div>
              </div>
            </div>
          </section>

          <section class="card" id="clausesCard">
            <h3><img src="https://imgur.com/K04axKU.png" alt=""><span id="uiClauses">Main Clauses</span></h3>
            <div class="list numbered" id="clausesList"></div>
          </section>

          <section class="card" id="scoreCard">
            <div class="hcard">
              <div class="circle">
                <svg width="160" height="160" viewBox="0 0 160 160">
                  <circle class="track" cx="80" cy="80" r="74"></circle>
                  <circle id="scoreArc" class="arc" cx="80" cy="80" r="74"></circle>
                </svg>
                <div class="score-center"><div class="score-pct" id="scorePct">80%</div></div>
              </div>
              <div class="score-side">
                <h3 style="margin-bottom:0"><img src="https://imgur.com/mFvyCj7.png" alt=""><span id="uiScoreChecker">Score Checker</span></h3>
                <div class="score-remark" id="scoreRemark">The contract is nearly perfectly done.</div>
                <div class="score-bar"><span class="score-ind" id="scoreInd"></span></div>
                <div class="score-scale"><span id="uiUnsafe">Unsafe</span><span id="uiSafe">Safe</span><span id="uiVerySafe">Very Safe</span></div>
              </div>
            </div>
          </section>

          <section class="card meter-block" id="confRightCard">
            <div class="meter-head">
              <div class="meter-title"><img src="https://imgur.com/nUGfg96.png" alt=""> <span id="uiConfidence">Confidence to sign freely</span></div>
              <div id="conf2Val">0%</div>
            </div>
            <div class="meter"><div id="conf2Fill" class="fill"></div></div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <div class="download-wrap" id="dlWrap">
    <button class="download" id="downloadBtn">Download Report</button>
  </div>

  <div class="modal" id="emailModal" aria-modal="true" role="dialog">
    <div class="modal-card">
      <h4>Enter your email to download the PDF report</h4>
      <div class="modal-row">
        <input id="emailInput" class="input" type="email" inputmode="email" placeholder="you@example.com" />
        <button class="btn primary" id="emailSubmit">Download</button>
        <button class="btn" id="emailCancel">Cancel</button>
      </div>
      <div id="emailErr" style="color:#ff6b6b;font-size:13px;margin-top:8px;display:none">Please enter a valid email address.</div>
    </div>
  </div>

  <script>
  (() => {
    // FORCE DEMO MODE (no live payload)
    localStorage.setItem("analysisMode","demo"); localStorage.removeItem("analysisRaw");

    /* ================= UI LABELS (i18n) ================= */
    const UI = {
      en:{overview:"Overview",title:"Title:",summary:"Summary",prof:"Professionalism",fav:"Favorability Index",deadline:"Deadline pressure",
          issues:"Potential Issues",suggestions:"Smart Suggestions",risk:"Risk Level",clarity:"Clause Clarity",clauses:"Main Clauses",
          score:"Score Checker",unsafe:"Unsafe",safe:"Safe",verysafe:"Very Safe",conf:"Confidence to sign freely",
          remark:{green:"The contract is nearly perfectly done.",orange:"The contract is done well.",red:"The contract isn’t done well."},
          band:{green:"Totally safe",orange:"Generally safe",red:"Not safe"}}
      // (other languages omitted here for brevity — they’re not used by the PDF code)
    };

    /* ===== Demo data ===== */
    const fallbackDemo = {
      meta: { title: "Sample Agreement", detectedLang: "en" },
      summary: [
        "The Vienna Convention establishes a framework for international sales contracts between parties from different countries.",
        "It outlines the rights and obligations of buyers and sellers, including provisions for contract formation, delivery, and liability.",
        "The Convention aims to promote uniformity in international trade and reduce legal barriers."
      ],
      risk: { value: 45, note: "The contract is generally safe, with clear provisions for both parties." },
      clarity: { value: 70, note: "The clauses are generally clear and well-structured, facilitating understanding." },
      clauses: [
        "The Convention applies to contracts for the sale of goods between parties whose places of business are in different countries.",
        "Parties may exclude the application of the Convention or derogate from its provisions.",
        "The seller must deliver goods that conform to the contract in terms of quantity, quality, and packaging.",
        "The buyer must pay the price and take delivery of the goods as stipulated in the contract.",
        "In case of non-compliance, the aggrieved party has the right to seek damages or terminate the contract."
      ],
      issues: [
        "Parties may not fully understand their rights and obligations under the Convention, leading to disputes.",
        "Exclusions or modifications to the Convention's provisions may create legal uncertainties.",
        "The lack of clarity in certain terms could lead to differing interpretations between parties.",
        "The Convention does not cover all aspects of sales, such as liability for personal injury or property damage.",
        "Parties must ensure compliance with local laws that may affect the enforceability of the contract."
      ],
      suggestions: [
        "Consider including a clause that specifies the governing law for any disputes, e.g., 'This contract shall be governed by the laws of Italy.'",
        "Ensure that all parties fully understand the implications of excluding any provisions of the Convention, e.g., 'Parties may opt-out of certain liability clauses.'",
        "Include a clear dispute resolution mechanism, e.g., 'Any disputes arising from this contract shall be resolved through arbitration in Vienna.'"
      ],
      meters: { professionalism: 65, favorability: 50, deadline: 40, confidence: 70 },
      translations: {}
    };

    const normalized = fallbackDemo;

    /* ================= Helpers ================= */
    const $ = s => document.querySelector(s);
    const cssVar = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const clamp01 = v => Math.max(0,Math.min(100,Number(v||0)));
    const addP = (el, t)=>{const p=document.createElement('p');p.textContent=t;el.appendChild(p);};
    const colorFor=(metric,v)=>{
      if(metric==='risk')     return v<=25?cssVar('--green'):v<=58?cssVar('--orange'):cssVar('--red');
      if(metric==='clarity')  return v>=78?cssVar('--green'):v>=49?cssVar('--orange'):cssVar('--red');
      if(metric==='deadline') return v<=35?cssVar('--green'):v<=68?cssVar('--orange'):cssVar('--red');
      return v>=75?cssVar('--green'):v>=49?cssVar('--orange'):cssVar('--red');
    };

    const currentLang = "en";
    function renderUILabels(lang){
      const t = UI[lang] || UI.en;
      $("#uiOverview").textContent = t.overview;
      $("#uiTitleLabel").textContent = t.title;
      $("#uiSummary").textContent = t.summary;
      $("#uiProfessionalism").textContent = t.prof;
      $("#uiFavorability").textContent = t.fav;
      $("#uiDeadline").textContent = t.deadline;
      $("#uiIssues").textContent = t.issues;
      $("#uiSuggestions").textContent = t.suggestions;
      $("#uiRisk").textContent = t.risk;
      $("#uiClarity").textContent = t.clarity;
      $("#uiClauses").textContent = t.clauses;
      $("#uiScoreChecker").textContent = t.score;
    }

    function getLocalizedContent(lang){
      return {
        title: normalized.meta.title,
        summary: normalized.summary,
        clauses: normalized.clauses,
        issues: normalized.issues,
        suggestions: normalized.suggestions,
        risk: { value: normalized.risk.value, note: normalized.risk.note },
        clarity: { value: normalized.clarity.value, note: normalized.clarity.note }
      };
    }

    function setArc(arcEl, metric, value, valEl){
      const v=clamp01(value); const rr=parseFloat(arcEl.getAttribute('r'))||74;
      const circ=2*Math.PI*rr;
      arcEl.style.stroke=colorFor(metric,v);
      arcEl.style.strokeDasharray=circ; arcEl.style.strokeDashoffset=circ;
      requestAnimationFrame(()=>{ arcEl.style.transition="stroke-dashoffset 1.8s ease"; arcEl.style.strokeDashoffset=circ*(1-v/100); });
      if(valEl) valEl.textContent=v+"%";
    }
    function setMeter(fillEl, labelEl, metric, value){
      const v=clamp01(value); labelEl.textContent=v+"%";
      fillEl.style.background=colorFor(metric,v);
      requestAnimationFrame(()=>{ fillEl.style.width=v+"%"; });
    }

    function renderAll(lang){
      renderUILabels(lang);
      $("#langNow").textContent = lang.toUpperCase();
      const data = getLocalizedContent(lang);

      $("#uiTitleValue").textContent = data.title || "—";

      const sBox=$("#summaryText"); sBox.innerHTML="";
      (Array.isArray(data.summary)?data.summary:[String(data.summary)]).forEach(t=>addP(sBox,t));

      const cl=$("#clausesList"); cl.innerHTML=""; (data.clauses||[]).forEach(t=>addP(cl,t));
      const il=$("#issuesList");  il.innerHTML=""; (data.issues||[]).forEach(t=>{const li=document.createElement('li'); li.textContent=t; il.appendChild(li);});
      const sl=$("#suggestionsList"); sl.innerHTML=""; (data.suggestions||[]).forEach(t=>addP(sl,t));

      const riskVal = clamp01(data.risk.value), clarVal = clamp01(data.clarity.value);
      setArc($("#riskArc"), 'risk', riskVal, $("#riskVal"));
      setArc($("#clarArc"), 'clarity', clarVal, $("#clarVal"));
      $("#riskNote").textContent = data.risk.note || "";
      $("#clarNote").textContent = data.clarity.note || "";

      setArc($("#scoreArc"), 'clarity', clarVal);
      $("#scorePct").textContent = clarVal + "%";
      $("#scoreInd").style.left = `calc(${clarVal}% - 1.5px)`;

      setMeter($("#confFill"), $("#confVal"), 'professionalism', normalized.meters.professionalism);
      setMeter($("#favFill"),  $("#favVal"),  'favorability',    normalized.meters.favorability);
      setMeter($("#deadFill"), $("#deadVal"), 'deadline',        normalized.meters.deadline);
      setMeter($("#conf2Fill"),$("#conf2Val"),'confidence',      normalized.meters.confidence);
    }

    /* ======= Init render ======= */
    renderAll(currentLang);

    /* ======= HOVER DROPDOWN ======= */
    const langBox = document.getElementById("lang");
    let closeTimer=null;
    const openMenu = ()=>{ clearTimeout(closeTimer); langBox.classList.add("open"); };
    const scheduleClose = ()=>{ clearTimeout(closeTimer); closeTimer=setTimeout(()=>langBox.classList.remove("open"), 140); };
    ["mouseenter","mousemove"].forEach(ev=>langBox.addEventListener(ev, openMenu));
    langBox.addEventListener("mouseleave", scheduleClose);

    /* ======= Reveal animations ======= */
    window.addEventListener('load', () => {
      ["#summaryCard","#riskCard","#clarCard"].forEach(sel => { const el=$(sel); if(el){el.classList.add('fade-in');}});
      setTimeout(()=>["#profCard","#favCard","#deadCard","#issuesCard","#clausesCard"].forEach(sel=>{const el=$(sel); if(el){el.classList.add('fade-in');}}), 180);
    });

    const io = new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('fade-in'); io.unobserve(e.target);} });},{ threshold: .18 });
    ["#suggestionsCard","#scoreCard","#confRightCard"].forEach(sel=>{ const el=$(sel); if(el){ io.observe(el); } });

    /* ======= Download modal & PDF ======= */
    const dlWrap=$("#dlWrap"), endBox=$("#sidebarEnd");
    function nearBottom(){
      const s=document.documentElement.scrollHeight-(window.scrollY+window.innerHeight);
      const show=s<=300;
      dlWrap.style.display=show?"flex":"none"; endBox.style.display=show?"block":"none";
      if(show){ dlWrap.classList.add('fade-in'); endBox.classList.add('fade-in'); }
    }
    window.addEventListener("scroll", nearBottom, {passive:true});
    window.addEventListener("load", nearBottom);

    const modal=$("#emailModal"),
          openModal=()=>modal.style.display="flex",
          closeModal=()=>modal.style.display="none";

    $("#downloadBtn").addEventListener("click", openModal);
    $("#emailCancel").addEventListener("click", closeModal);

    const validEmail = e => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||"").trim());
    $("#emailSubmit").addEventListener("click", async ()=>{
      const email=$("#emailInput").value||"", err=$("#emailErr");
      if(!validEmail(email)){ err.style.display="block"; return; }
      err.style.display="none";
      const lang=currentLang; const data = getLocalizedContent(lang);
      try{
        await generatePDF("SignSense_Report", data, lang);
      }catch(e){ console.error(e); alert("Could not generate the PDF."); }
      closeModal();
    });

    /* ====== Poppins loader for jsPDF (Regular + Bold) ====== */
    async function ensurePoppins(doc){
      try {
        const list = doc.getFontList ? doc.getFontList() : {};
        if (list && list.Poppins) return true;

        const REG_URL = "https://cdn.jsdelivr.net/gh/google/fonts/ofl/poppins/Poppins-Regular.ttf";
        const BLD_URL = "https://cdn.jsdelivr.net/gh/google/fonts/ofl/poppins/Poppins-Bold.ttf";

        async function fetchAsBase64(url){
          const r = await fetch(url, {mode:"cors"});
          if (!r.ok) throw new Error("font fetch failed " + r.status);
          const buf = await r.arrayBuffer();
          let binary = "";
          const bytes = new Uint8Array(buf);
          for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
          return btoa(binary);
        }

        const [regB64, boldB64] = await Promise.all([fetchAsBase64(REG_URL), fetchAsBase64(BLD_URL)]);
        doc.addFileToVFS("Poppins-Regular.ttf", regB64);
        doc.addFont("Poppins-Regular.ttf", "Poppins", "normal");
        doc.addFileToVFS("Poppins-Bold.ttf", boldB64);
        doc.addFont("Poppins-Bold.ttf", "Poppins", "bold");
        return true;
      } catch (e) {
        console.warn("Poppins failed to load — using helvetica fallback.", e);
        return false;
      }
    }

    /* === icons & marks === */
    const ASSETS = {
      logo:       "https://imgur.com/aRIGT9V.png",
      risk:       "https://imgur.com/hSkzUQu.png",
      clarity:    "https://imgur.com/3J3mzur.png",
      pro:        "https://imgur.com/FLqsaQJ.png",
      fav:        "https://imgur.com/GIAYFBC.png",
      dead:       "https://imgur.com/BbyV5gF.png",
      score:      "https://imgur.com/H47wt5e.png",
      confidence: "https://imgur.com/GzPeaz5.png"
    };

    /* === image URL -> dataURL for jsPDF === */
    async function imgToDataURL(url){
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = url;
      await new Promise((res, rej)=>{ img.onload = res; img.onerror = rej; });
      const c = document.createElement("canvas");
      c.width = img.naturalWidth; c.height = img.naturalHeight;
      c.getContext("2d").drawImage(img, 0, 0);
      return c.toDataURL("image/png");
    }

    /* ================= Main generator (Poppins everywhere if available) ================= */
  /* ================= Main generator (Updated Layout) ================= */
async function generatePDF(filename, d, lang){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  // Load Poppins font
  const ok = await ensurePoppins(doc);
  const FONT = (doc.getFontList && doc.getFontList().Poppins) ? "Poppins" : "helvetica";
  doc.setFont(FONT, "normal");

  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const M = 40; // Margin

  // Preload icons
  const IM = {};
  for (const k in ASSETS) {
    try { IM[k] = await imgToDataURL(ASSETS[k]); } catch { IM[k] = null; }
  }

  /* === Utilities === */
  const bold = () => doc.setFont(FONT, "bold");
  const reg = () => doc.setFont(FONT, "normal");

  const header = (pageNo) => {
    // Black header
    doc.setFillColor(0, 0, 0);
    doc.rect(0, 0, W, 110, "F");
    doc.setTextColor(255, 255, 255);
    bold(); doc.setFontSize(42);
    doc.text("Contract Report", M, 65);
    reg(); doc.setFontSize(16);

    const dt = new Date();
    const day = dt.getDate().toString().padStart(2,"0");
    const month = dt.toLocaleString('en', { month:'long' });
    const year = dt.getFullYear();
    doc.text(`Generated on ${day} ${month} ${year}`, M, 92);

    // Page number black box bottom left
    doc.setFillColor(0,0,0);
    doc.roundedRect(M, H-54, 100, 34, 8, 8, "F");
    doc.setTextColor(255,255,255);
    bold(); doc.setFontSize(14);
    doc.text(`PAGE ${pageNo}`, M+20, H-32);

    // Logo bottom right
    if (IM.logo) doc.addImage(IM.logo, "PNG", W-140, H-84, 110, 30);

    // Disclaimer
    reg(); doc.setFontSize(11); doc.setTextColor(0,0,0);
    const prefix = "Kindly keep in mind that although you might find this report helpful, this is ";
    const suffix = " legal advice.";
    let x = M; const y = H-10;
    doc.text(prefix, x, y); x += doc.getTextWidth(prefix);
    bold();
    const notW = doc.getTextWidth("not");
    doc.text("not", x, y);
    doc.line(x, y+2, x+notW, y+2);
    x += notW; reg();
    doc.text(suffix, x, y);
    doc.line(M, y+2, x + doc.getTextWidth(suffix), y+2);
  };

  const blackBorderBox = (x,y,w,h) => {
    doc.setDrawColor(0,0,0);
    doc.setLineWidth(3);
    doc.roundedRect(x,y,w,h,10,10);
  };

  const barWithIcon = (label, value, icon, yPos) => {
    const barH = 36, barW = W - (M*2) - 20;
    blackBorderBox(M, yPos, barW, barH);
    if(icon) doc.addImage(icon,"PNG",M+10,yPos+6,24,24);
    bold(); doc.setFontSize(14); doc.setTextColor(0,0,0);
    doc.text(label, M+44, yPos+24);
    const pct = `${value}%`;
    const tx = M + barW - 40 - doc.getTextWidth(pct);
    doc.text(pct, tx, yPos+24);
    // Fill bar
    const innerW = barW - 20;
    doc.setFillColor(0,0,0);
    doc.rect(M+10, yPos+barH-14, innerW * (value/100), 10, "F");
  };

  /* ========== PAGE 1 ========== */
  header(1);
  let y = 140;

  // Title
  bold(); doc.setFontSize(14); doc.setTextColor(0,0,0);
  doc.text("Title:", M, y);
  reg(); doc.text(` ${d.title || "—"}`, M+45, y);
  y += 28;

  // Summary
  bold(); doc.setFontSize(14); doc.text("Summary of Contract:", M, y);
  y += 12;
  const summaryY = y;
  const summaryTxt = Array.isArray(d.summary) ? d.summary.join("\n\n") : d.summary;
  const lines = doc.splitTextToSize(summaryTxt, W - (M*2) - 30);
  let lineY = y + 22;
  reg(); doc.setFontSize(11); doc.setTextColor(0,0,0);
  lines.forEach(line => { doc.text(line, M+16, lineY); lineY += 16; });
  const sumHeight = (lineY - summaryY) + 14;
  blackBorderBox(M-6, summaryY-10, W - (M*2) + 12, sumHeight);
  y = summaryY + sumHeight + 30;

  // Percentage Breakdown
  bold(); doc.setFontSize(16); doc.text("Percentage Breakdown", M, y);
  y += 20;

  const boxW = (W - M*2 - 20) / 2;
  const boxH = 140;
  const riskX = M;
  const clarityX = M + boxW + 20;

  // Risk Level
  blackBorderBox(riskX, y, boxW, boxH);
  if(IM.risk) doc.addImage(IM.risk,"PNG", riskX+14, y+14, 28, 28);
  bold(); doc.setFontSize(14); doc.text("Risk Level", riskX+50, y+32);
  bold(); doc.setFontSize(32); doc.text(`${d.risk?.value || 0}%`, riskX+30, y+86);
  reg(); doc.setFontSize(11); doc.text("Clear terms overall, but", riskX+120, y+66);
  doc.text("missing late fees and", riskX+120, y+82);
  doc.text("dispute process.", riskX+120, y+98);

  // Clause Clarity
  blackBorderBox(clarityX, y, boxW, boxH);
  if(IM.clarity) doc.addImage(IM.clarity,"PNG", clarityX+14, y+14, 28, 28);
  bold(); doc.setFontSize(14); doc.text("Clause Clarity", clarityX+50, y+32);
  bold(); doc.setFontSize(32); doc.text(`${d.clarity?.value || 0}%`, clarityX+30, y+86);
  reg(); doc.setFontSize(11); doc.text("Plain language used, but", clarityX+120, y+66);
  doc.text("some clauses need", clarityX+120, y+82);
  doc.text("clearer detail.", clarityX+120, y+98);

  y += boxH + 40;

  // Statistical Bars
  bold(); doc.setFontSize(16); doc.text("Statistical Bars", M, y);
  y += 20;
  barWithIcon("Professionalism", d.meters?.professionalism ?? 65, IM.pro, y); y += 50;
  barWithIcon("Favorability Index", d.meters?.favorability ?? 50, IM.fav, y); y += 50;
  barWithIcon("Deadline Pressure", d.meters?.deadline ?? 40, IM.dead, y); y += 70;

  // Main Clauses
  bold(); doc.setFontSize(16); doc.text("Main Clauses", M, y);
  y += 14;
  const clauseStart = y;
  const clauses = d.clauses || [];
  reg(); doc.setFontSize(11);
  clauses.forEach((c, i)=>{
    const num = `${i+1}. `;
    doc.text(num + c, M+14, y);
    y += 20;
  });
  const clauseHeight = (y - clauseStart) + 14;
  blackBorderBox(M-6, clauseStart-10, W - (M*2) + 12, clauseHeight);

  header(1); // footer on first page
  doc.addPage();

  /* ========== PAGE 2 ========== */
  header(2);
  y = 140;

  // Potential Issues
  bold(); doc.setFontSize(16); doc.text("Potential Issues that might occur", M, y);
  y += 14;
  const issuesStart = y;
  const issues = d.issues || [];
  reg(); doc.setFontSize(11);
  issues.forEach(i=>{
    doc.text("• " + i, M+14, y);
    y += 20;
  });
  const issuesHeight = (y - issuesStart) + 14;
  blackBorderBox(M-6, issuesStart-10, W - (M*2) + 12, issuesHeight);
  y += 40;

  // Smart Suggestions
  bold(); doc.setFontSize(16); doc.text("Smart Suggestions", M, y);
  y += 14;
  const ssStart = y;
  const suggestions = d.suggestions || [];
  suggestions.forEach((s, i)=>{
    doc.text(`${i+1}. ${s}`, M+14, y);
    y += 22;
  });
  const ssHeight = (y - ssStart) + 14;
  blackBorderBox(M-6, ssStart-10, W - (M*2) + 12, ssHeight);
  y += 40;

  // Bottom row: Score Checker + Confidence
  const leftW = (W - M*2 - 20) * 0.55;
  const rightW = (W - M*2 - 20) - leftW;
  const scX = M;
  const cfX = M + leftW + 20;
  const bottomH = 140;

  // Score Checker
  blackBorderBox(scX, y, leftW, bottomH);
  if(IM.score) doc.addImage(IM.score,"PNG", scX+14, y+14, 28, 28);
  bold(); doc.setFontSize(14); doc.text("Score Checker", scX+50, y+32);
  bold(); doc.setFontSize(32);
  const scorePct = d.clarity?.value || 0;
  doc.text(`${scorePct}%`, scX+30, y+86);
  reg(); doc.setFontSize(11); doc.text("The contract is nearly perfectly done.", scX+30, y+108);

  // Confidence to sign freely
  blackBorderBox(cfX, y, rightW, bottomH);
  if(IM.confidence) doc.addImage(IM.confidence,"PNG", cfX+14, y+14, 28, 28);
  bold(); doc.setFontSize(14); doc.text("Confidence to sign freely", cfX+50, y+32);
  const conf = d.meters?.confidence ?? 70;
  doc.setFillColor(255,200,0);
  const barWidth = rightW - 50;
  doc.rect(cfX+20, y+70, barWidth * (conf/100), 20, "F");
  bold(); doc.setFontSize(12); doc.setTextColor(0,0,0);
  doc.text(`${conf}%`, cfX + barWidth - 10, y+66);

  header(2); // footer on second page

  doc.save((filename || "SignSense_Report") + ".pdf");
} 

    document.getElementById("leaveReview").addEventListener("click", (e)=>{ e.preventDefault(); alert("Hook this to your reviews form URL."); });
  })();
  </script>
</body>
</html>
