<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SignSense — Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400&display=swap" rel="stylesheet" />
  <style>
    :root{ --bg:#0e0c13; --card:#1c1b22; --border:#3b3b3b; --white:#ffffff; --muted:#bdbdbd;
           --green:#00ff65; --orange:#df911a; --red:#fe0000; --black:#000000;
           --radius:21px; --gap:18px; --sidebar:300px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--white);font:400 16px/1.7 Inter,system-ui,Segoe UI,Roboto,Arial}
    .layout{display:grid;grid-template-columns:var(--sidebar) 1fr;min-height:100vh}
    .sidebar{background:#0f0e14;border-right:1px solid var(--border);padding:12px 16px 16px;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;gap:16px}
    .brand{padding:0 2px 0 18px}.brand a{display:flex;align-items:center;gap:12px;height:52px;text-decoration:none;color:var(--white)}
    .brand img{width:34px;height:34px}.brand span{font-size:24px;color:var(--white);font-weight:400}
    .nav{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .nav a{text-decoration:none;color:var(--muted);display:flex;align-items:center;gap:16px;padding:16px 18px;border-radius:16px;border:1px solid transparent;transition:border-color .2s ease;font-size:19px;}
    .nav a img.icon{width:30px;height:30px;opacity:.95}.nav a img.arr{width:20px;height:20px;opacity:.9}
    .nav a.active{background:#181620;border:1px solid var(--border);color:var(--white)} .nav a:hover{background:transparent;border-color:var(--border);color:var(--white)}
    .push{flex:1}.end-only{display:none}
    .main{padding:0 20px 60px;display:grid;grid-template-rows:auto auto 1fr;gap:12px}
    .topbar{position:sticky;top:0;z-index:5;background:var(--bg);display:flex;align-items:flex-end;justify-content:space-between;padding:8px 6px 10px;height:64px;border-bottom:1px solid var(--border)}
    .top-left{display:flex;align-items:center;gap:12px}.top-title{font-size:20px;color:var(--white);font-weight:400}
    .doc-title{display:flex;align-items:center;gap:8px;padding:2px 6px 0 6px}
    .doc-title .label,.doc-title .value{font-size:18px;color:var(--muted);font-weight:400}

    .lang{position:relative;padding:6px 4px}
    .lang-btn{display:flex;align-items:center;gap:8px;background:transparent;border:none;color:var(--white);font:400 20px/1 Inter;cursor:pointer;padding:6px 10px;min-width:40px}
    .lang-btn .caret{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid #fff;opacity:.9}
    .lang-menu{position:absolute;right:0;top:calc(100% + 8px);background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:240px;max-height:260px;overflow:auto;display:none;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:6px}
    .lang.open .lang-menu{display:block}
    .lang-item{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;color:var(--white);cursor:pointer}
    .lang-item:hover{background:#17161e}

    .grid{display:grid;grid-template-columns:minmax(560px,1.25fr) minmax(560px,1fr);gap:var(--gap);align-items:start;margin-top:6px}
    .left,.right{display:flex;flex-direction:column;gap:var(--gap)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px 18px 20px}
    .card h3{margin:0 0 16px;display:flex;align-items:center;gap:12px;font-size:24px;color:var(--white);font-weight:400}
    .card h3 img{width:30px;height:30px}
    .list{display:flex;flex-direction:column;gap:16px}
    .list p{margin:0;color:var(--muted);font-size:20px;overflow-wrap:anywhere;word-break:break-word}
    .bullets{margin:0;color:var(--muted);font-size:20px;padding-left:22px;list-style:disc}
    .bullets li{margin:0 0 12px}

    .meter-block{display:flex;flex-direction:column;gap:10px}
    .meter-head{display:flex;align-items:center;justify-content:space-between}
    .meter-title{display:flex;align-items:center;gap:12px;font-size:22px}
    .meter{height:10px;border-radius:999px;background:var(--black);overflow:hidden}
    .fill{height:100%;width:0%;transition:width 1.0s ease;border-radius:999px}

    .hcard{display:flex;gap:16px;align-items:center}
    .circle{width:160px;height:160px;position:relative;display:grid;place-items:center;flex:0 0 160px}
    .circle svg{transform:rotate(-90deg)}
    .circle .val{position:absolute;font-weight:400;font-size:34px;color:var(--white)}
    .circle circle.track{stroke:var(--black);stroke-width:12;fill:none}
    .circle circle.arc{stroke-width:12;fill:none;stroke-linecap:round;stroke-dasharray:440;stroke-dashoffset:440;transition:stroke-dashoffset 1.0s ease}
    .muted{color:var(--muted);font-size:18px}
    .status{display:flex;align-items:center;gap:8px;margin-top:8px}
    .status .dot{width:10px;height:10px;border-radius:2px}
    .score-side{flex:1;display:flex;flex-direction:column;gap:14px}
    .score-remark{font-size:20px;color:var(--muted)}
    .score-bar{position:relative;height:22px;border-radius:14px;background:linear-gradient(90deg,#ff6b6b 0%, #ffd166 45%, #00e676 100%);border:1px solid #2f2f2f;box-shadow:inset 0 1px 0 rgba(255,255,255,.05);width:100%}
    .score-ind{position:absolute;top:-6px;height:34px;width:3px;background:#fff;border-radius:2px;box-shadow:0 0 8px rgba(255,255,255,.6)}
    .score-scale{display:flex;justify-content:space-between;font-size:16px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <a href="index.html"><img src="https://imgur.com/Z5hv7K9.png" alt="SignSense"><span>SignSense</span></a>
      </div>
      <nav class="nav">
        <a class="active" href="#"><img class="arr" src="https://imgur.com/CHGomYz.png" alt=""><img class="icon" src="https://imgur.com/lnQTDuo.png" alt=""><span>Overview</span></a>
        <a href="index.html"><img class="arr" src="https://imgur.com/xhkeG0y.png" alt=""><img class="icon" src="https://imgur.com/kE3okdE.png" alt=""><span>Home</span></a>
        <a href="privacy.html"><img class="arr" src="https://imgur.com/xhkeG0y.png" alt=""><img class="icon" src="https://imgur.com/krMnFVT.png" alt=""><span>Privacy</span></a>
        <a href="#"><img class="arr" src="https://imgur.com/xhkeG0y.png" alt=""><img class="icon" src="https://imgur.com/6zHviT6.png" alt=""><span>Contact Us</span></a>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="top-left"><div class="top-title" id="uiOverview">Overview</div></div>
        <div class="lang" id="lang">
          <button class="lang-btn" id="langBtn" type="button"><span id="langNow">EN</span><span class="caret"></span></button>
          <div class="lang-menu" id="langMenu">
            <div class="lang-item" data-code="en">English</div><div class="lang-item" data-code="it">Italiano</div>
            <div class="lang-item" data-code="de">Deutsch</div><div class="lang-item" data-code="es">Español</div>
            <div class="lang-item" data-code="fr">Français</div><div class="lang-item" data-code="pt">Português</div>
            <div class="lang-item" data-code="nl">Nederlands</div><div class="lang-item" data-code="ro">Română</div>
            <div class="lang-item" data-code="sq">Shqip</div><div class="lang-item" data-code="tr">Türkçe</div>
            <div class="lang-item" data-code="zh">中文</div><div class="lang-item" data-code="ja">日本語</div>
          </div>
        </div>
      </div>

      <div class="doc-title"><span class="label" id="uiTitleLabel">Title:</span> <span class="value" id="uiTitleValue">—</span></div>

      <div class="grid">
        <div class="left">
          <section class="card" id="summaryCard"><h3><img src="https://imgur.com/CuQFbD7.png" alt=""><span id="uiSummary">Summary</span></h3><div class="list" id="summaryText"></div></section>

          <section class="card meter-block" id="profCard"><div class="meter-head"><div class="meter-title">
            <img src="https://imgur.com/EdMAMnx.png" alt=""> <span id="uiProfessionalism">Professionalism</span></div><div id="confVal">0%</div></div>
            <div class="meter"><div id="confFill" class="fill"></div></div></section>

          <section class="card meter-block" id="favCard"><div class="meter-head"><div class="meter-title">
            <img src="https://imgur.com/UDRuIvO.png" alt=""> <span id="uiFavorability">Favorability Index</span></div><div id="favVal">0%</div></div>
            <div class="meter"><div id="favFill" class="fill"></div></div></section>

          <section class="card meter-block" id="deadCard"><div class="meter-head"><div class="meter-title">
            <img src="https://imgur.com/VXZ3kD8.png" alt=""> <span id="uiDeadline">Deadline pressure</span></div><div id="deadVal">0%</div></div>
            <div class="meter"><div id="deadFill" class="fill"></div></div></section>

          <section class="card" id="issuesCard"><h3><img src="https://imgur.com/ppLDtiq.png" alt=""><span id="uiIssues">Potential Issues</span></h3><ul class="bullets" id="issuesList"></ul></section>

          <section class="card" id="suggestionsCard"><h3><img src="https://imgur.com/EoVDfd5.png" alt=""><span id="uiSuggestions">Smart Suggestions</span></h3><div class="list" id="suggestionsList"></div></section>
        </div>

        <div class="right">
          <section class="card" id="riskCard"><div class="hcard">
            <div class="circle"><svg width="160" height="160" viewBox="0 0 160 160"><circle class="track" cx="80" cy="80" r="74"></circle><circle id="riskArc" class="arc" cx="80" cy="80" r="74"></circle></svg><div class="val" id="riskVal">0%</div></div>
            <div class="htext"><h3 style="margin-bottom:0"><img src="https://imgur.com/Myp6Un4.png" alt=""><span id="uiRisk">Risk Level</span></h3>
              <div class="muted" id="riskNote"></div><div class="status"><span class="dot" id="riskDot"></span><span id="riskBadge">Totally safe</span></div></div></div></section>

          <section class="card" id="clarCard"><div class="hcard">
            <div class="circle"><svg width="160" height="160" viewBox="0 0 160 160"><circle class="track" cx="80" cy="80" r="74"></circle><circle id="clarArc" class="arc" cx="80" cy="80" r="74"></circle></svg><div class="val" id="clarVal">0%</div></div>
            <div class="htext"><h3 style="margin-bottom:0"><img src="https://imgur.com/o39xZtC.png" alt=""><span id="uiClarity">Clause Clarity</span></h3>
              <div class="muted" id="clarNote"></div><div class="status"><span class="dot" id="clarDot"></span><span id="clarBadge">Not safe</span></div></div></div></section>

          <section class="card" id="clausesCard"><h3><img src="https://imgur.com/K04axKU.png" alt=""><span id="uiClauses">Main Clauses</span></h3><div class="list" id="clausesList"></div></section>

          <section class="card" id="scoreCard"><div class="hcard">
            <div class="circle"><svg width="160" height="160" viewBox="0 0 160 160"><circle class="track" cx="80" cy="80" r="74"></circle><circle id="scoreArc" class="arc" cx="80" cy="80" r="74"></circle></svg><div class="val" id="scorePct">0%</div></div>
            <div class="score-side"><h3 style="margin-bottom:0"><img src="https://imgur.com/mFvyCj7.png" alt=""><span id="uiScoreChecker">Score Checker</span></h3>
              <div class="score-remark" id="scoreRemark">—</div><div class="score-bar"><span class="score-ind" id="scoreInd"></span></div>
              <div class="score-scale"><span id="uiUnsafe">Unsafe</span><span id="uiSafe">Safe</span><span id="uiVerySafe">Very Safe</span></div></div></div></section>

          <section class="card meter-block" id="confRightCard"><div class="meter-head"><div class="meter-title">
            <img src="https://imgur.com/nUGfg96.png" alt=""> <span id="uiConfidence">Confidence to sign freely</span></div><div id="conf2Val">0%</div></div>
            <div class="meter"><div id="conf2Fill" class="fill"></div></div></section>
        </div>
      </div>
    </main>
  </div>

<script>
(() => {
  // ===== i18n (added confidence key) =====
  const UI = {
    en:{overview:"Overview",title:"Title:",summary:"Summary",prof:"Professionalism",fav:"Favorability Index",deadline:"Deadline pressure",
        issues:"Potential Issues",suggestions:"Smart Suggestions",risk:"Risk Level",clarity:"Clause Clarity",clauses:"Main Clauses",
        score:"Score Checker",unsafe:"Unsafe",safe:"Safe",verysafe:"Very Safe",confidence:"Confidence to sign freely",
        remark:{green:"The contract is nearly perfectly done.",orange:"The contract is done well.",red:"The contract isn’t done well."},
        band:{green:"Totally safe",orange:"Generally safe",red:"Not safe"}},
    it:{overview:"Panoramica",title:"Titolo:",summary:"Sintesi",prof:"Professionalità",fav:"Indice di favorevolezza",deadline:"Pressione delle scadenze",
        issues:"Problemi potenziali",suggestions:"Suggerimenti intelligenti",risk:"Livello di rischio",clarity:"Chiarezza delle clausole",clauses:"Clausole principali",
        score:"Verifica punteggio",unsafe:"Rischioso",safe:"Sicuro",verysafe:"Molto sicuro",confidence:"Fiducia nel firmare liberamente",
        remark:{green:"Il contratto è quasi perfetto.",orange:"Il contratto è fatto bene.",red:"Il contratto non è fatto bene."},
        band:{green:"Completamente sicuro",orange:"Generalmente sicuro",red:"Non sicuro"}},
    de:{overview:"Übersicht",title:"Titel:",summary:"Zusammenfassung",prof:"Professionalität",fav:"Günstigkeitsindex",deadline:"Termindruck",
        issues:"Mögliche Probleme",suggestions:"Smarte Vorschläge",risk:"Risikostufe",clarity:"Klausel-Klarheit",clauses:"Wesentliche Klauseln",
        score:"Score-Prüfer",unsafe:"Unsicher",safe:"Sicher",verysafe:"Sehr sicher",confidence:"Zuversicht, frei zu unterschreiben",
        remark:{green:"Der Vertrag ist nahezu perfekt.",orange:"Der Vertrag ist gut gemacht.",red:"Der Vertrag ist nicht gut gemacht."},
        band:{green:"Völlig sicher",orange:"Im Allgemeinen sicher",red:"Nicht sicher"}},
    es:{overview:"Resumen",title:"Título:",summary:"Síntesis",prof:"Profesionalidad",fav:"Índice de favorabilidad",deadline:"Presión de plazos",
        issues:"Problemas potenciales",suggestions:"Sugerencias inteligentes",risk:"Nivel de riesgo",clarity:"Claridad de cláusulas",clauses:"Cláusulas principales",
        score:"Comprobador de puntuación",unsafe:"Inseguro",safe:"Seguro",verysafe:"Muy seguro",confidence:"Confianza para firmar libremente",
        remark:{green:"El contrato está casi perfecto.",orange:"El contrato está bien hecho.",red:"El contrato no está bien hecho."},
        band:{green:"Totalmente seguro",orange:"Generalmente seguro",red:"No seguro"}},
    fr:{overview:"Aperçu",title:"Titre :",summary:"Résumé",prof:"Professionnalisme",fav:"Indice de favorabilité",deadline:"Pression des délais",
        issues:"Problèmes potentiels",suggestions:"Suggestions intelligentes",risk:"Niveau de risque",clarity:"Clarté des clauses",clauses:"Clauses principales",
        score:"Contrôle du score",unsafe:"Risque",safe:"Sûr",verysafe:"Très sûr",confidence:"Confiance pour signer librement",
        remark:{green:"Le contrat est presque parfait.",orange:"Le contrat est bien fait.",red:"Le contrat n’est pas bien fait."},
        band:{green:"Totalement sûr",orange:"Généralement sûr",red:"Pas sûr"}},
    pt:{overview:"Visão geral",title:"Título:",summary:"Resumo",prof:"Profissionalismo",fav:"Índice de favorabilidade",deadline:"Pressão de prazo",
        issues:"Problemas potenciais",suggestions:"Sugestões inteligentes",risk:"Nível de risco",clarity:"Clareza das cláusulas",clauses:"Cláusulas principais",
        score:"Verificador de pontuação",unsafe:"Arriscado",safe:"Seguro",verysafe:"Muito seguro",confidence:"Confiança para assinar livremente",
        remark:{green:"O contrato está quase perfeito.",orange:"O contrato está bem elaborado.",red:"O contrato não está bem elaborado."},
        band:{green:"Totalmente seguro",orange:"Geralmente seguro",red:"Não seguro"}},
    nl:{overview:"Overzicht",title:"Titel:",summary:"Samenvatting",prof:"Professionaliteit",fav:"Voordeligheidsindex",deadline:"Deadline-druk",
        issues:"Potentiële problemen",suggestions:"Slimme suggesties",risk:"Risiconiveau",clarity:"Duidelijkheid van clausules",clauses:"Belangrijkste clausules",
        score:"Scorecontrole",unsafe:"Onveilig",safe:"Veilig",verysafe:"Zeer veilig",confidence:"Vertrouwen om vrij te tekenen",
        remark:{green:"Het contract is bijna perfect.",orange:"Het contract is goed opgesteld.",red:"Het contract is niet goed opgesteld."},
        band:{green:"Helemaal veilig",orange:"Over het algemeen veilig",red:"Niet veilig"}},
    ro:{overview:"Prezentare",title:"Titlu:",summary:"Rezumat",prof:"Profesionalism",fav:"Indice de favorabilitate",deadline:"Presiunea termenelor",
        issues:"Probleme potențiale",suggestions:"Sugestii inteligente",risk:"Nivel de risc",clarity:"Claritatea clauzelor",clauses:"Clauze principale",
        score:"Verificator de scor",unsafe:"Nesigur",safe:"Sigur",verysafe:"Foarte sigur",confidence:"Încredere de a semna liber",
        remark:{green:"Contractul este aproape perfect.",orange:"Contractul este bine realizat.",red:"Contractul nu este bine realizat."},
        band:{green:"Complet sigur",orange:"În general sigur",red:"Nesigur"}},
    sq:{overview:"Përmbledhje",title:"Titulli:",summary:"Përmbledhje",prof:"Profesionalizmi",fav:"Indeksi i favorshmërisë",deadline:"Presioni i afateve",
        issues:"Çështje të mundshme",suggestions:"Sugjerime të zgjuara",risk:"Niveli i rrezikut",clarity:"Qartësia e klauzolave",clauses:"Klauzolat kryesore",
        score:"Kontrolluesi i pikëve",unsafe:"E pasigurt",safe:"E sigurt",verysafe:"Shumë e sigurt",confidence:"Besim për të nënshkruar lirshëm",
        remark:{green:"Kontrata është pothuajse perfekte.",orange:"Kontrata është bërë mirë.",red:"Kontrata nuk është bërë mirë."},
        band:{green:"Plotësisht e sigurt",orange:"Në përgjithësi e sigurt",red:"Jo e sigurt"}},
    tr:{overview:"Genel bakış",title:"Başlık:",summary:"Özet",prof:"Profesyonellik",fav:"Elverişlilik Endeksi",deadline:"Zaman baskısı",
        issues:"Olası sorunlar",suggestions:"Akıllı öneriler",risk:"Risk seviyesi",clarity:"Hüküm açıklığı",clauses:"Ana hükümler",
        score:"Puan denetleyici",unsafe:"Güvensiz",safe:"Güvenli",verysafe:"Çok güvenli",confidence:"Özgürce imzalama güveni",
        remark:{green:"Sözleşme neredeyse kusursuz.",orange:"Sözleşme iyi hazırlanmış.",red:"Sözleşme iyi hazırlanmış değil."},
        band:{green:"Tamamen güvenli",orange:"Genel olarak güvenli",red:"Güvenli değil"}},
    ja:{overview:"概要",title:"タイトル：",summary:"要約",prof:"プロ意識",fav:"有利性指数",deadline:"締切プレッシャー",
        issues:"潜在的な問題",suggestions:"スマート提案",risk:"リスク水準",clarity:"条項の明確さ",clauses:"主要条項",
        score:"スコア確認",unsafe:"危険",safe:"安全",verysafe:"非常に安全",confidence:"自由に署名する自信",
        remark:{green:"契約はほぼ完璧です。",orange:"契約は良くできています。",red:"契約は十分ではありません。"},
        band:{green:"完全に安全",orange:"概ね安全",red:"安全ではない"}},
    zh:{overview:"概览",title:"标题：",summary:"摘要",prof:"专业性",fav:"有利指数",deadline:"期限压力",
        issues:"潜在问题",suggestions:"智能建议",risk:"风险等级",clarity:"条款清晰度",clauses:"主要条款",
        score:"评分检查",unsafe:"不安全",safe:"安全",verysafe:"非常安全",confidence:"可放心签署的信心",
        remark:{green:"合同几乎完美。",orange:"合同完成得很好。",red:"合同完成得不好。"},
        band:{green:"完全安全",orange:"总体安全",red:"不安全"}}
  };

  // ===== get payload from localStorage (no analysisMode dependency) =====
  let payload = {};
  try { payload = JSON.parse(localStorage.getItem("analysisRaw") || "{}"); } catch {}
  if (!payload || !payload.analysis) {
    // tiny fallback (still renders)
    payload = {
      contractTitle:"Contract",
      detectedLang:"en",
      analysis:{ summary:["…"], risk:{value:0,note:""}, clarity:{value:0,note:""},
        mainClauses:[], potentialIssues:[], smartSuggestions:[],
        bars:{professionalism:0,favorabilityIndex:0,deadlinePressure:0,confidenceToSign:0},
        scoreChecker:{value:0, line:"The contract isnt done well"} },
      translations:{}
    };
  }

  // ===== helpers =====
  const $ = s => document.querySelector(s);
  const cssVar = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
  const clamp01 = v => Math.max(0,Math.min(100,Number(v||0)));
  const bad = x => !x || x==="string" || x==="…" || x==="...";

  const colorFor=(metric,v)=>{
    if(metric==='risk')     return v<=25?cssVar('--green'):v<=58?cssVar('--orange'):cssVar('--red');
    if(metric==='clarity')  return v>=78?cssVar('--green'):v>=49?cssVar('--orange'):cssVar('--red');
    if(metric==='deadline') return v<=35?cssVar('--green'):v<=68?cssVar('--orange'):cssVar('--red');
    return v>=75?cssVar('--green'):v>=49?cssVar('--orange'):cssVar('--red');
  };
  const bandFor=(metric,v)=>{
    if(metric==='risk')     return v<=25?'green':v<=58?'orange':'red';
    if(metric==='clarity')  return v>=78?'green':v>=49?'orange':'red';
    return v>=75?'green':v>=49?'orange':'red';
  };

  // ===== language selection =====
  const supported = Object.keys(UI);
  let currentLang = supported.includes((payload.detectedLang||"en").toLowerCase()) ? (payload.detectedLang||"en").toLowerCase() : "en";

  function renderUILabels(lang){
    const t = UI[lang] || UI.en;
    $("#uiOverview").textContent = t.overview;
    $("#uiTitleLabel").textContent = t.title;
    $("#uiSummary").textContent = t.summary;
    $("#uiProfessionalism").textContent = t.prof;
    $("#uiFavorability").textContent = t.fav;
    $("#uiDeadline").textContent = t.deadline;
    $("#uiIssues").textContent = t.issues;
    $("#uiSuggestions").textContent = t.suggestions;
    $("#uiRisk").textContent = t.risk;
    $("#uiClarity").textContent = t.clarity;
    $("#uiClauses").textContent = t.clauses;
    $("#uiScoreChecker").textContent = t.score;
    $("#uiUnsafe").textContent = t.unsafe;
    $("#uiSafe").textContent = t.safe;
    $("#uiVerySafe").textContent = t.verysafe;
    $("#uiConfidence").textContent = t.confidence;
  }

  function getLocalizedContent(lang){
    const a = payload.analysis || {};
    const tr = payload.translations || {};
    const seg = tr[lang] || {};
    const pickArr = (cand, base=[]) => (Array.isArray(cand) && cand.filter(x=>!bad(x)).length ? cand : base).filter(x=>!bad(x));
    const title = !bad(seg.title) ? seg.title : (payload.contractTitle || payload.contractName || "—");

    return {
      title,
      summary: pickArr(seg.summary, a.summary||[]),
      clauses: pickArr(seg.mainClauses, a.mainClauses||[]),
      issues: pickArr(seg.potentialIssues, a.potentialIssues||[]),
      suggestions: pickArr(seg.smartSuggestions, a.smartSuggestions||[]),
      risk: { value: Number(a.risk?.value||0), note: bad(seg.riskNote)? (a.risk?.note||"") : seg.riskNote },
      clarity: { value: Number(a.clarity?.value||0), note: bad(seg.clarityNote)? (a.clarity?.note||"") : seg.clarityNote },
      bars: {
        professionalism: Number(a.bars?.professionalism||0),
        favorability: Number(a.bars?.favorabilityIndex||0),
        deadline: Number(a.bars?.deadlinePressure||0),
        confidence: Number(a.bars?.confidenceToSign||0)
      },
      score: Number(a.scoreChecker?.value||0),
      scoreRemarkLine: a.scoreChecker?.line || ""
    };
  }

  function setArc(arcEl, metric, value, valEl){
    const v=clamp01(value), rr=parseFloat(arcEl.getAttribute('r'))||74, circ=2*Math.PI*rr;
    arcEl.style.stroke=colorFor(metric,v);
    arcEl.style.strokeDasharray=circ; arcEl.style.strokeDashoffset=circ*(1-v/100);
    if(valEl) valEl.textContent=v+"%";
  }
  function setMeter(fillEl, labelEl, metric, value){
    const v=clamp01(value); labelEl.textContent=v+"%";
    fillEl.style.background=colorFor(metric,v); fillEl.style.width=v+"%";
  }

  function renderAll(lang){
    const t = UI[lang] || UI.en;
    renderUILabels(lang);
    $("#langNow").textContent = lang.toUpperCase();

    const d = getLocalizedContent(lang);
    $("#uiTitleValue").textContent = d.title || "—";

    const sBox=$("#summaryText"); sBox.innerHTML=""; (d.summary||[]).forEach(x=>{const p=document.createElement('p'); p.textContent=x; sBox.appendChild(p);});
    const cl=$("#clausesList"); cl.innerHTML=""; (d.clauses||[]).forEach(x=>{const p=document.createElement('p'); p.textContent=x; cl.appendChild(p);});
    const il=$("#issuesList");  il.innerHTML=""; (d.issues||[]).forEach(x=>{const li=document.createElement('li'); li.textContent=x; il.appendChild(li);});
    const sl=$("#suggestionsList"); sl.innerHTML=""; (d.suggestions||[]).forEach(x=>{const p=document.createElement('p'); p.textContent=x; sl.appendChild(p);});

    setArc($("#riskArc"), 'risk', d.risk.value, $("#riskVal"));
    setArc($("#clarArc"), 'clarity', d.clarity.value, $("#clarVal"));
    $("#riskNote").textContent = d.risk.note || "";
    $("#clarNote").textContent = d.clarity.note || "";

    const rBand = d.risk.value<=25?'green':d.risk.value<=58?'orange':'red';
    const cBand = d.clarity.value>=78?'green':d.clarity.value>=49?'orange':'red';
    $("#riskDot").style.background = colorFor('risk', d.risk.value);
    $("#clarDot").style.background = colorFor('clarity', d.clarity.value);
    $("#riskBadge").textContent = t.band[rBand];
    $("#clarBadge").textContent = t.band[cBand];

    // SCORE from scoreChecker (not clarity)
    setArc($("#scoreArc"), 'clarity', d.score, null);
    $("#scorePct").textContent = clamp01(d.score) + "%";
    $("#scoreInd").style.left = `calc(${clamp01(d.score)}% - 1.5px)`;
    $("#scoreRemark").textContent = d.scoreRemarkLine || ((d.score>=78)?t.remark.green:(d.score>=49)?t.remark.orange:t.remark.red);

    setMeter($("#confFill"), $("#confVal"), 'professionalism', d.bars.professionalism);
    setMeter($("#favFill"),  $("#favVal"),  'favorability',    d.bars.favorability);
    setMeter($("#deadFill"), $("#deadVal"), 'deadline',        d.bars.deadline);
    setMeter($("#conf2Fill"),$("#conf2Val"),'confidence',      d.bars.confidence);
  }

  // init
  const startLang = (payload.detectedLang||"en").toLowerCase();
  renderAll(UI[startLang] ? startLang : "en");

  // hover menu
  const langBox = document.getElementById("lang");
  let closeTimer=null;
  const openMenu = ()=>{ clearTimeout(closeTimer); langBox.classList.add("open"); };
  const scheduleClose = ()=>{ clearTimeout(closeTimer); closeTimer=setTimeout(()=>langBox.classList.remove("open"), 140); };
  ["mouseenter","mousemove"].forEach(ev=>langBox.addEventListener(ev, openMenu));
  langBox.addEventListener("mouseleave", scheduleClose);
  document.querySelectorAll(".lang-item").forEach(item=>{
    item.addEventListener("click", ()=>{ const code=item.getAttribute("data-code"); renderAll(code); scheduleClose(); });
  });
})();
</script>
</body>
</html>
