<script>
(() => {
/* ================= UI LABELS (i18n) ================= */
const UI = {
  en:{overview:"Overview",title:"Title:",summary:"Summary",prof:"Professionalism",fav:"Favorability Index",deadline:"Deadline pressure",
      issues:"Potential Issues",suggestions:"Smart Suggestions",risk:"Risk Level",clarity:"Clause Clarity",clauses:"Main Clauses",
      score:"Score Checker",unsafe:"Unsafe",safe:"Safe",verysafe:"Very Safe",confidence:"Confidence to sign freely",
      remark:{green:"The contract is nearly perfectly done.",orange:"The contract is done well.",red:"The contract isn’t done well."},
      band:{green:"Totally safe",orange:"Generally safe",red:"Not safe"}},
  it:{overview:"Panoramica",title:"Titolo:",summary:"Sintesi",prof:"Professionalità",fav:"Indice di favorevolezza",deadline:"Pressione delle scadenze",
      issues:"Problemi potenziali",suggestions:"Suggerimenti intelligenti",risk:"Livello di rischio",clarity:"Chiarezza delle clausole",clauses:"Clausole principali",
      score:"Verifica punteggio",unsafe:"Rischioso",safe:"Sicuro",verysafe:"Molto sicuro",confidence:"Fiducia nel firmare liberamente",
      remark:{green:"Il contratto è quasi perfetto.",orange:"Il contratto è fatto bene.",red:"Il contratto non è fatto bene."},
      band:{green:"Completamente sicuro",orange:"Generalmente sicuro",red:"Non sicuro"}},
  de:{overview:"Übersicht",title:"Titel:",summary:"Zusammenfassung",prof:"Professionalität",fav:"Günstigkeitsindex",deadline:"Termindruck",
      issues:"Mögliche Probleme",suggestions:"Smarte Vorschläge",risk:"Risikostufe",clarity:"Klausel-Klarheit",clauses:"Wesentliche Klauseln",
      score:"Score-Prüfer",unsafe:"Unsicher",safe:"Sicher",verysafe:"Sehr sicher",confidence:"Zuversicht, frei zu unterschreiben",
      remark:{green:"Der Vertrag ist nahezu perfekt.",orange:"Der Vertrag ist gut gemacht.",red:"Der Vertrag ist nicht gut gemacht."},
      band:{green:"Völlig sicher",orange:"Im Allgemeinen sicher",red:"Nicht sicher"}},
  es:{overview:"Resumen",title:"Título:",summary:"Síntesis",prof:"Profesionalidad",fav:"Índice de favorabilidad",deadline:"Presión de plazos",
      issues:"Problemas potenciales",suggestions:"Sugerencias inteligentes",risk:"Nivel de riesgo",clarity:"Claridad de cláusulas",clauses:"Cláusulas principales",
      score:"Comprobador de puntuación",unsafe:"Inseguro",safe:"Seguro",verysafe:"Muy seguro",confidence:"Confianza para firmar libremente",
      remark:{green:"El contrato está casi perfecto.",orange:"El contrato está bien hecho.",red:"El contrato no está bien hecho."},
      band:{green:"Totalmente seguro",orange:"Generalmente seguro",red:"No seguro"}},
  fr:{overview:"Aperçu",title:"Titre :",summary:"Résumé",prof:"Professionnalisme",fav:"Indice de favorabilité",deadline:"Pression des délais",
      issues:"Problèmes potentiels",suggestions:"Suggestions intelligentes",risk:"Niveau de risque",clarity:"Clarté des clauses",clauses:"Clauses principales",
      score:"Contrôle du score",unsafe:"Risque",safe:"Sûr",verysafe:"Très sûr",confidence:"Confiance pour signer librement",
      remark:{green:"Le contrat est presque parfait.",orange:"Le contrat est bien fait.",red:"Le contrat n’est pas bien fait."},
      band:{green:"Totalement sûr",orange:"Généralement sûr",red:"Pas sûr"}},
  pt:{overview:"Visão geral",title:"Título:",summary:"Resumo",prof:"Profissionalismo",fav:"Índice de favorabilidade",deadline:"Pressão de prazo",
      issues:"Problemas potenciais",suggestions:"Sugestões inteligentes",risk:"Nível de risco",clarity:"Clareza das cláusulas",clauses:"Cláusulas principais",
      score:"Verificador de pontuação",unsafe:"Arriscado",safe:"Seguro",verysafe:"Muito seguro",confidence:"Confiança para assinar livremente",
      remark:{green:"O contrato está quase perfeito.",orange:"O contrato está bem elaborado.",red:"O contrato não está bem elaborado."},
      band:{green:"Totalmente seguro",orange:"Geralmente seguro",red:"Não seguro"}},
  nl:{overview:"Overzicht",title:"Titel:",summary:"Samenvatting",prof:"Professionaliteit",fav:"Voordeligheidsindex",deadline:"Deadline-druk",
      issues:"Potentiële problemen",suggestions:"Slimme suggesties",risk:"Risiconiveau",clarity:"Duidelijkheid van clausules",clauses:"Belangrijkste clausules",
      score:"Scorecontrole",unsafe:"Onveilig",safe:"Veilig",verysafe:"Zeer veilig",confidence:"Zelfvertrouwen om vrij te tekenen",
      remark:{green:"Het contract is bijna perfect.",orange:"Het contract is goed opgesteld.",red:"Het contract is niet goed opgesteld."},
      band:{green:"Helemaal veilig",orange:"Over het algemeen veilig",red:"Niet veilig"}},
  ro:{overview:"Prezentare",title:"Titlu:",summary:"Rezumat",prof:"Profesionalism",fav:"Indice de favorabilitate",deadline:"Presiunea termenelor",
      issues:"Probleme potențiale",suggestions:"Sugestii inteligente",risk:"Nivel de risc",clarity:"Claritatea clauzelor",clauses:"Clauze principale",
      score:"Verificator de scor",unsafe:"Nesigur",safe:"Sigur",verysafe:"Foarte sigur",confidence:"Încredere de a semna liber",
      remark:{green:"Contractul este aproape perfect.",orange:"Contractul este bine realizat.",red:"Contractul nu este bine realizat."},
      band:{green:"Complet sigur",orange:"În general sigur",red:"Nesigur"}},
  sq:{overview:"Përmbledhje",title:"Titulli:",summary:"Përmbledhje",prof:"Profesionalizmi",fav:"Indeksi i favorshmërisë",deadline:"Presioni i afateve",
      issues:"Çështje të mundshme",suggestions:"Sugjerime të zgjuara",risk:"Niveli i rrezikut",clarity:"Qartësia e klauzolave",clauses:"Klauzolat kryesore",
      score:"Kontrolluesi i pikëve",unsafe:"E pasigurt",safe:"E sigurt",verysafe:"Shumë e sigurt",confidence:"Besimi për të nënshkruar lirshëm",
      remark:{green:"Kontrata është pothuajse perfekte.",orange:"Kontrata është bërë mirë.",red:"Kontrata nuk është bërë mirë."},
      band:{green:"Plotësisht e sigurt",orange:"Në përgjithësi e sigurt",red:"Jo e sigurt"}},
  tr:{overview:"Genel bakış",title:"Başlık:",summary:"Özet",prof:"Profesyonellik",fav:"Elverişlilik Endeksi",deadline:"Zaman baskısı",
      issues:"Olası sorunlar",suggestions:"Akıllı öneriler",risk:"Risk seviyesi",clarity:"Hüküm açıklığı",clauses:"Ana hükümler",
      score:"Puan denetleyici",unsafe:"Güvensiz",safe:"Güvenli",verysafe:"Çok güvenli",confidence:"Özgürce imzalama güveni",
      remark:{green:"Sözleşme neredeyse kusursuz.",orange:"Sözleşme iyi hazırlanmış.",red:"Sözleşme iyi hazırlanmış değil."},
      band:{green:"Tamamen güvenli",orange:"Genel olarak güvenli",red:"Güvenli değil"}},
  ja:{overview:"概要",title:"タイトル：",summary:"要約",prof:"プロ意識",fav:"有利性指数",deadline:"締切プレッシャー",
      issues:"潜在的な問題",suggestions:"スマート提案",risk:"リスク水準",clarity:"条項の明確さ",clauses:"主要条項",
      score:"スコア確認",unsafe:"危険",safe:"安全",verysafe:"非常に安全",confidence:"自由に署名する自信",
      remark:{green:"契約はほぼ完璧です。",orange:"契約は良くできています。",red:"契約は十分ではありません。"},
      band:{green:"完全に安全",orange:"概ね安全",red:"安全ではない"}},
  zh:{overview:"概览",title:"标题：",summary:"摘要",prof:"专业性",fav:"有利指数",deadline:"期限压力",
      issues:"潜在问题",suggestions:"智能建议",risk:"风险等级",clarity:"条款清晰度",clauses:"主要条款",
      score:"评分检查",unsafe:"不安全",safe:"安全",verysafe:"非常安全",confidence:"放心自由签署的信心",
      remark:{green:"合同几乎完美。",orange:"合同完成得很好。",red:"合同完成得不好。"},
      band:{green:"完全安全",orange:"总体安全",red:"不安全"}}
};

/* ============== DATA ============== */
const fallbackDemo = {
  contractTitle:"Sample Agreement",
  detectedLang:"en",
  analysis:{
    summary:["…"], risk:{value:45,note:"…"}, clarity:{value:70,note:"…"},
    mainClauses:["…"], potentialIssues:["…"], smartSuggestions:["…"],
    bars:{professionalism:65,favorabilityIndex:50,deadlinePressure:40,confidenceToSign:70},
    scoreChecker:{value:70}
  },
  translations:{} // runtime cache will be stored here too
};

const mode = localStorage.getItem("analysisMode");
let payload = fallbackDemo;
if (mode === "live") { try { payload = JSON.parse(localStorage.getItem("analysisRaw") || "{}"); } catch {} }

const $ = s => document.querySelector(s);
const cssVar = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
const clamp01 = v => Math.max(0,Math.min(100,Number(v||0)));
const addP = (el, t)=>{const p=document.createElement('p');p.textContent=t;el.appendChild(p);};
const colorFor=(metric,v)=>{
  if(metric==='risk')     return v<=25?cssVar('--green'):v<=58?cssVar('--orange'):cssVar('--red');
  if(metric==='clarity')  return v>=78?cssVar('--green'):v>=49?cssVar('--orange'):cssVar('--red');
  if(metric==='deadline') return v<=35?cssVar('--green'):v<=68?cssVar('--orange'):cssVar('--red');
  return v>=75?cssVar('--green'):v>=49?cssVar('--orange'):cssVar('--red');
};
const bandFor=(metric,v)=>{
  if(metric==='risk')     return v<=25?'green':v<=58?'orange':'red';
  if(metric==='clarity')  return v>=78?'green':v>=49?'orange':'red';
  return v>=75?'green':v>=49?'orange':'red';
};
const sanitizeNote=s=>{const v=(s||"").trim(); return (v==="string"||v==="…")?"":v;};

const supported = Object.keys(UI);
const baseLang = (payload.detectedLang||"en").toLowerCase();
let currentLang = supported.includes(baseLang) ? baseLang : "en";

// cache translations in payload.translations
payload.translations = payload.translations || {};

function baseSegments(){
  const a = payload.analysis || {};
  return {
    title: payload.contractTitle || payload.contractName || "—",
    summary: a.summary || [],
    mainClauses: a.mainClauses || [],
    potentialIssues: a.potentialIssues || [],
    smartSuggestions: a.smartSuggestions || [],
    riskNote: a.risk?.note || "",
    clarityNote: a.clarity?.note || ""
  };
}

async function ensureTranslation(lang){
  if (lang === baseLang) return; // base text already in that language
  const have = payload.translations[lang];
  const complete = have && typeof have.title==="string" &&
                   Array.isArray(have.summary) && Array.isArray(have.mainClauses) &&
                   Array.isArray(have.potentialIssues) && Array.isArray(have.smartSuggestions) &&
                   typeof have.riskNote==="string" && typeof have.clarityNote==="string";
  if (complete) return;

  // translate on demand
  const src = baseLang;
  const segs = baseSegments();
  try{
    const resp = await fetch("api/translate.js", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ target: lang, source: src, ...segs })
    });
    if (resp.ok){
      const out = await resp.json();
      payload.translations[lang] = out || {};
      // persist to localStorage so subsequent visits are instant
      if (mode === "live") localStorage.setItem("analysisRaw", JSON.stringify(payload));
    }
  }catch(e){ console.error("translate fetch failed", e); }
}

function renderUILabels(lang){
  const t = UI[lang] || UI.en;
  $("#uiOverview").textContent = t.overview;
  $("#uiTitleLabel").textContent = t.title;
  $("#uiSummary").textContent = t.summary;
  $("#uiProfessionalism").textContent = t.prof;
  $("#uiFavorability").textContent = t.fav;
  $("#uiDeadline").textContent = t.deadline;
  $("#uiIssues").textContent = t.issues;
  $("#uiSuggestions").textContent = t.suggestions;
  $("#uiRisk").textContent = t.risk;
  $("#uiClarity").textContent = t.clarity;
  $("#uiClauses").textContent = t.clauses;
  $("#uiScoreChecker").textContent = t.score;
  $("#uiUnsafe").textContent = t.unsafe;
  $("#uiSafe").textContent = t.safe;
  $("#uiVerySafe").textContent = t.verysafe;
  const conf = $("#uiConfidence"); if (conf) conf.textContent = t.confidence;
}

function getLocalizedContent(lang){
  const a = payload.analysis || {};
  const tr = payload.translations || {};
  const seg = tr[lang] || {};
  return {
    title: typeof seg.title === "string" ? seg.title : (payload.contractTitle || payload.contractName || "—"),
    summary: Array.isArray(seg.summary)&&seg.summary.length ? seg.summary : (a.summary||[]),
    clauses: Array.isArray(seg.mainClauses)&&seg.mainClauses.length ? seg.mainClauses : (a.mainClauses||[]),
    issues: Array.isArray(seg.potentialIssues)&&seg.potentialIssues.length ? seg.potentialIssues : (a.potentialIssues||[]),
    suggestions: Array.isArray(seg.smartSuggestions)&&seg.smartSuggestions.length ? seg.smartSuggestions : (a.smartSuggestions||[]),
    risk: { value: Number(a.risk?.value||0), note: sanitizeNote(seg.riskNote ?? a.risk?.note) },
    clarity: { value: Number(a.clarity?.value||0), note: sanitizeNote(seg.clarityNote ?? a.clarity?.note) },
    bars: {
      professionalism: Number(a.bars?.professionalism||0),
      favorability: Number(a.bars?.favorabilityIndex||0),
      deadline: Number(a.bars?.deadlinePressure||0),
      confidence: Number(a.bars?.confidenceToSign||0)
    },
    scoreVal: Number(a.scoreChecker?.value||0)
  };
}

function setArc(arcEl, metric, value, valEl){
  const v=clamp01(value); const rr=parseFloat(arcEl.getAttribute('r'))||74;
  const circ=2*Math.PI*rr;
  arcEl.style.stroke=colorFor(metric,v);
  arcEl.style.strokeDasharray=circ; arcEl.style.strokeDashoffset=circ;
  requestAnimationFrame(()=>{ arcEl.style.transition="stroke-dashoffset 1.8s ease"; arcEl.style.strokeDashoffset=circ*(1-v/100); });
  if(valEl) valEl.textContent=v+"%";
}
function setMeter(fillEl, labelEl, metric, value){
  const v=clamp01(value); labelEl.textContent=v+"%";
  fillEl.style.background=colorFor(metric,v);
  requestAnimationFrame(()=>{ fillEl.style.width=v+"%"; });
}

async function renderAll(lang){
  // if we don't have translated segments yet -> fetch them
  await ensureTranslation(lang);

  renderUILabels(lang);
  $("#langNow").textContent = lang.toUpperCase();

  const d = getLocalizedContent(lang);

  $("#uiTitleValue").textContent = d.title || "—";

  const sBox=$("#summaryText"); sBox.innerHTML=""; (d.summary||[]).forEach(t=>addP(sBox,t));
  const cl=$("#clausesList"); cl.innerHTML=""; (d.clauses||[]).forEach(t=>addP(cl,t));
  const il=$("#issuesList");  il.innerHTML=""; (d.issues||[]).forEach(t=>{const li=document.createElement('li'); li.textContent=t; il.appendChild(li);});
  const sl=$("#suggestionsList"); sl.innerHTML=""; (d.suggestions||[]).forEach(t=>addP(sl,t));

  setArc($("#riskArc"), 'risk', d.risk.value, $("#riskVal"));
  setArc($("#clarArc"), 'clarity', d.clarity.value, $("#clarVal"));
  $("#riskNote").textContent = d.risk.note || "";
  $("#clarNote").textContent = d.clarity.note || "";

  const rBand = bandFor('risk', d.risk.value), cBand = bandFor('clarity', d.clarity.value);
  $("#riskDot").style.background = colorFor('risk', d.risk.value);
  $("#clarDot").style.background = colorFor('clarity', d.clarity.value);
  const t = UI[lang] || UI.en;
  $("#riskBadge").textContent = t.band[rBand];
  $("#clarBadge").textContent = t.band[cBand];

  setArc($("#scoreArc"), 'clarity', d.clarity.value);
  $("#scorePct").textContent = clamp01(d.clarity.value) + "%";
  $("#scoreInd").style.left = `calc(${clamp01(d.clarity.value)}% - 1.5px)`;
  $("#scoreRemark").textContent = (d.clarity.value>=78) ? t.remark.green : (d.clarity.value>=49) ? t.remark.orange : t.remark.red;

  setMeter($("#confFill"), $("#confVal"), 'professionalism', d.bars.professionalism);
  setMeter($("#favFill"),  $("#favVal"),  'favorability',    d.bars.favorability);
  setMeter($("#deadFill"), $("#deadVal"), 'deadline',        d.bars.deadline);
  setMeter($("#conf2Fill"),$("#conf2Val"),'confidence',      d.bars.confidence);
}

/* ======= Init render ======= */
renderAll(currentLang);

/* ======= Hover-stay-open dropdown ======= */
const langBox = document.getElementById("lang");
let closeTimer=null;
const openMenu = ()=>{ clearTimeout(closeTimer); langBox.classList.add("open"); };
const scheduleClose = ()=>{ clearTimeout(closeTimer); closeTimer=setTimeout(()=>langBox.classList.remove("open"), 160); };
["mouseenter","mousemove"].forEach(ev=>langBox.addEventListener(ev, openMenu));
langBox.addEventListener("mouseleave", scheduleClose);
document.querySelectorAll(".lang-item").forEach(item=>{
  item.addEventListener("click", async ()=>{
    const code=item.getAttribute("data-code"); if(!code) return;
    currentLang = code; await renderAll(currentLang); scheduleClose();
  });
});

/* ======= Reveal animations, PDF, etc. (unchanged) ======= */
const $q = s => document.querySelector(s);
window.addEventListener('load', () => {
  ["#summaryCard","#riskCard","#clarCard"].forEach(sel => { const el=$q(sel); if(el){el.classList.add('fade-in');}});
  setTimeout(()=>["#profCard","#favCard","#deadCard","#issuesCard","#clausesCard"].forEach(sel=>{const el=$q(sel); if(el){el.classList.add('fade-in');}}), 180);
});
const io = new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('fade-in'); io.unobserve(e.target);} });},{ threshold: .18 });
["#suggestionsCard","#scoreCard","#confRightCard"].forEach(sel=>{ const el=$q(sel); if(el){ io.observe(el); } });

const dlWrap=$("#dlWrap"), endBox=$("#sidebarEnd");
function nearBottom(){ const s=document.documentElement.scrollHeight-(window.scrollY+window.innerHeight); const show=s<=300;
  dlWrap.style.display=show?"flex":"none"; endBox.style.display=show?"block":"none";
  if(show){ dlWrap.classList.add('fade-in'); endBox.classList.add('fade-in'); } }
window.addEventListener("scroll", nearBottom, {passive:true}); window.addEventListener("load", nearBottom);

const modal=$("#emailModal"), openModal=()=>modal.style.display="flex", closeModal=()=>modal.style.display="none";
$("#downloadBtn").addEventListener("click", openModal);
$("#emailCancel").addEventListener("click", closeModal);
const validEmail = e => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((e||"").trim());
$("#emailSubmit").addEventListener("click", async ()=>{
  const email=$("#emailInput").value||"", err=$("#emailErr");
  if(!validEmail(email)){ err.style.display="block"; return; }
  err.style.display="none"; await generatePDF(currentLang); closeModal();
});

async function generatePDF(lang){
  const d = getLocalizedContent(lang); const t = UI[lang] || UI.en;
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF({ unit:"pt", format:"a4" });
  const pageW=doc.internal.pageSize.getWidth();
  const margin=48, width=pageW-margin*2, lh=18;

  doc.setFillColor(28,27,34); doc.rect(0,0,pageW,80,'F');
  doc.setTextColor(255,255,255); doc.setFont("helvetica","normal"); doc.setFontSize(18);
  doc.text("SignSense — " + (t.overview || "Overview"), margin, 48);

  let y=100;
  const date=new Date().toLocaleString(); doc.setFontSize(10); doc.setTextColor(189,189,189);
  doc.text(`Generated: ${date}`, margin, y); y+=lh*1.6;

  y=section((t.title||"Title:") + " " + (d.title||"—"), y);
  y=section(t.summary||"Summary", y); y=bullets(d.summary, y);
  y=section(`${t.risk||"Risk Level"}: ${clamp01(d.risk.value)}%`, y); y=paragraph(d.risk.note||"", y);
  y=section(`${t.clarity||"Clause Clarity"}: ${clamp01(d.clarity.value)}%`, y); y=paragraph(d.clarity.note||"", y);
  y=section(t.clauses||"Main Clauses", y); y=bullets(d.clauses, y);
  y=section(t.issues||"Potential Issues", y); y=bullets(d.issues, y);
  y=section(t.suggestions||"Smart Suggestions", y); y=bullets(d.suggestions, y);
  doc.save("SignSense_Report.pdf");

  function section(t,y){ if(y>780){ doc.addPage(); y=64; } doc.setFont("helvetica","normal"); doc.setTextColor(255,255,255); doc.setFontSize(12); doc.text(t, margin, y); return y+12; }
  function paragraph(text,y){ if(!text) return y; doc.setFont("helvetica","normal"); doc.setTextColor(189,189,189); doc.setFontSize(11); let lines=doc.splitTextToSize(text,width); lines.forEach(line=>{ if(y>780){doc.addPage(); y=64;} doc.text(line, margin, y); y+=lh;}); return y; }
  function bullets(arr,y){ const list=Array.isArray(arr)?arr:[]; doc.setFont("helvetica","normal"); doc.setTextColor(189,189,189); doc.setFontSize(11);
    list.forEach(t=>{ const lines=doc.splitTextToSize(String(t),width-12);
      if(y>780){doc.addPage(); y=64;} doc.text("•", margin, y);
      lines.forEach((line,i)=>{ if(i===0){doc.text(line, margin+12, y);} else { y+=lh; doc.text(line, margin+12, y);} });
      y+=lh;
    }); return y;
  }
}

document.getElementById("leaveReview").addEventListener("click", (e)=>{ e.preventDefault(); alert("Hook this to your reviews form URL."); });
})();
</script>
