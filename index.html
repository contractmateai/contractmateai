from pathlib import Path

# Load the user's existing HTML UI code and prepare to integrate the fixed script section
base_ui_path = Path("/mnt/data/contractmate_ui.html")

# Save the user's original UI content
ui_html = """
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Contract Mate</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/128/18960/18960926.png" type="image/png">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #0b0b0f;
      color: #f5f5f5;
    }
    header {
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 32px;
      background-color: #000;
    }
    header .logo {
      display: flex;
      align-items: center;
      text-decoration: none;
    }
    header img {
      height: 52px;
      margin-right: 14px;
    }
    header h1 {
      font-size: 26px;
      margin: 0;
      color: #ffffff;
    }
    .menu {
      position: relative;
    }
    .menu-button {
      background: none;
      border: 2px solid #888;
      color: #f5f5f5;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
    }
    .menu-content {
      display: none;
      position: absolute;
      top: 50px;
      right: 0;
      background-color: #1a1a20;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 12px;
      z-index: 1000;
      width: 180px;
    }
    .menu-content a {
      display: block;
      padding: 10px;
      color: #f5f5f5;
      text-decoration: none;
      font-size: 16px;
    }
    .menu-content a:hover {
      background-color: #292934;
    }
    .menu:hover .menu-content,
    .menu:focus-within .menu-content {
      display: block;
    }
    .section {
      padding: 40px 24px;
      text-align: center;
    }
    .cta-button-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      border: 2px solid #2068c1;
      border-radius: 12px;
      padding: 16px 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      background-color: transparent;
      box-shadow: 0 0 16px rgba(32, 104, 193, 0.4);
    }
    .cta-button-wrapper:hover {
      background-color: #000;
    }
    .cta-button-wrapper img {
      height: 40px;
    }
    .cta-button-wrapper span {
      font-size: 22px;
      color: #2068c1;
    }
    .upload-input {
      display: none;
    }
    .video-placeholder iframe {
      width: 100%;
      max-width: 820px;
      height: 460px;
      border-radius: 12px;
      box-shadow: 0 0 16px rgba(32, 104, 193, 0.4);
      border: none;
    }
    .testimonials-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      flex-wrap: wrap;
      margin-top: 40px;
    }
    .testimonial {
      background: #1c1c26;
      color: #f5f5f5;
      padding: 28px;
      border-radius: 16px;
      width: 320px;
      font-size: 18px;
      box-shadow: 0 0 16px rgba(32, 104, 193, 0.3);
    }
    .leave-review-btn {
      margin-top: 30px;
      font-size: 18px;
      color: #2068c1;
      border: 2px solid #2068c1;
      padding: 14px 22px;
      border-radius: 10px;
      background-color: transparent;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .leave-review-btn:hover {
      background-color: #1a1a1a;
    }
    footer {
      background-color: #1a1a24;
      color: #bbb;
      text-align: center;
      padding: 40px 20px 20px;
    }
    .footer-icons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 40px;
      margin: 16px 0;
    }
    .footer-icons img {
      height: 36px;
      filter: brightness(200%);
      border-radius: 8px;
    }
    .footer-nav {
      margin-top: 16px;
    }
    .footer-nav a {
      color: #bbb;
      margin: 0 10px;
      text-decoration: none;
    }
    @media (max-width: 768px) {
      .section {
        padding: 20px 16px 40px;
      }
      .cta-button-wrapper {
        padding: 12px 20px;
      }
    }
  </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script>
  const openaiKey = "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";

  document.getElementById("fileInput").addEventListener("change", async function(event) {
    const file = event.target.files[0];
    const resultDiv = document.getElementById("analysisResult");
    const output = document.getElementById("outputText");
    resultDiv.style.display = "block";

    if (!file || !file.name.endsWith(".pdf")) {
      alert("Please upload a PDF file.");
      return;
    }

    output.innerText = "Reading file...";

    const pdfData = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

    let fullText = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const strings = content.items.map(item => item.str).join(" ");
      fullText += strings + "\n";
    }

    // If empty, use OCR instead
    if (fullText.trim().length < 20) {
      output.innerText = "No text found, trying OCR...";

      const pdfBlob = new Blob([pdfData], { type: "application/pdf" });
      const pdfURL = URL.createObjectURL(pdfBlob);
      const img = await pdfToImage(pdfURL);

      const result = await Tesseract.recognize(img, 'eng');
      fullText = result.data.text;
    }

    fullText = fullText.trim().replace(/\s+/g, ' ');
    if (fullText.length > 4000) {
      fullText = fullText.substring(0, 4000);
    }

    output.innerText = "Sending to GPT...";

    const prompt = You're a legal assistant. Read and analyze the following contract. Identify key terms, risks, unusual clauses, and summarize it clearly:\n\n${fullText};

    try {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": Bearer ${openaiKey}
        },
        body: JSON.stringify({
          model: "gpt-4",
          messages: [{ role: "user", content: prompt }],
          temperature: 0.4
        })
      });

      const data = await res.json();
      output.innerText = data?.choices?.[0]?.message?.content || "No response.";
    } catch (e) {
      output.innerText = "Error: " + e.message;
    }
  });

  async function pdfToImage(url) {
    const loadingTask = pdfjsLib.getDocument(url);
    const pdf = await loadingTask.promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 2.5 });

    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    await page.render({ canvasContext: context, viewport }).promise;
    return canvas.toDataURL("image/png");
  }
</script>
</head>
<body>
  <header>
    <a class="logo" href="index.html">
      <img src="https://cdn-icons-png.flaticon.com/128/18960/18960926.png" alt="Logo" />
      <h1>AI ContractMate</h1>
    </a>
    <div class="menu" tabindex="0">
      <button class="menu-button">☰</button>
      <div class="menu-content">
        <a href="index.html">Home</a>
        <a href="https://www.youtube.com">See How It Works</a>
        <a href="contact.html">Contact</a>
      </div>
    </div>
  </header>

  <div class="section">
    <p style="font-size: 22px; max-width: 780px; margin: 0 auto 32px; line-height: 1.8;">
      <strong>AI ContractMate</strong> gives you instant clarity in contract reviews.<br><br>
      It helps law firms, freelancers, and students understand what they're about to sign — before even hiring a lawyer.<br><br>
      It also assists legal professionals in analyzing contracts clearly.
    </p>

    <div style="margin-top: 32px;">
      <label class="cta-button-wrapper" for="fileInput">
        <img src="https://cdn-icons-png.flaticon.com/128/18960/18960926.png" alt="Contract Icon" />
        <span>Review My Contract</span>
      </label>
      <input type="file" id="fileInput" accept=".pdf" style="display: none;" />
    </div>

    <div id="analysisResult" style="margin-top: 40px; max-width: 800px; margin-left: auto; margin-right: auto; background-color: #1c1c26; padding: 20px; border-radius: 10px; display: none;">
      <h3 style="color:#fff;">Analysis Result</h3>
      <div id="outputText" style="white-space: pre-wrap; color: #ccc;"></div>
    </div>
  </div>

  <div class="section video-placeholder">
    <h2 style="font-size: 28px; margin-bottom: 20px;">See How It Works</h2>
    <iframe src="https://www.youtube.com/embed/placeholder" title="How AI ContractMate Works" allowfullscreen></iframe>
  </div>

  <hr style="border: none; height: 1px; background-color: #222; margin: 60px auto; width: 80%;">

  <div class="section">
    <h2 style="font-size: 30px; font-weight: 600; margin-bottom: 20px; letter-spacing: 0.5px;">What Our Users Say</h2>
    <div class="testimonials-container">
      <div class="testimonial">
        <span style="color: gold; font-size: 22px;">★★★★★</span><br>
        "This helped me understand a complex NDA in 30 seconds."<br>
        <strong>— Aisha M., Startup Founder</strong>
      </div>
      <div class="testimonial">
        <span style="color: gold; font-size: 22px;">★★★★★</span><br>
        "Clear, fast, and surprisingly accurate contract analysis. I love it."<br>
        <strong>— Marco T., Freelance Developer</strong>
      </div>
      <div class="testimonial">
        <span style="color: gold; font-size: 22px;">★★★★★</span><br>
        "Saves time and gives real insight into contracts without needing a lawyer."<br>
        <strong>— Linnea R., Law Student</strong>
      </div>
    </div>
  </div>

  <footer>
    <p style="color: #ccc; font-weight: 500;">Not legal advice. For informational use only.</p>
    <div class="footer-icons">
      <a href="#"><img src="https://i.pinimg.com/736x/8f/94/c6/8f94c616ec0a60bafb4de4e0260719da.jpg" alt="Instagram" /></a>
      <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" alt="YouTube" /></a>
      <a href="#"><img src="https://img.freepik.com/free-vector/new-2023-twitter-logo-x-icon-design_1017-45418.jpg" alt="X (Twitter)" /></a>
    </div>
    <div class="footer-nav">
      <a href="#">Home</a> | <a href="contact.html">Contact</a>
    </div>
    <p style="color: gray;">©️ 2025 AI ContractMate</p>
  </footer>

  <script>
    const openaiKey = "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";

    document.getElementById("fileInput").addEventListener("change", async function(event) {
      const file = event.target.files[0];
      if (!file || !file.name.endsWith(".pdf")) {
        alert("Please upload a PDF file.");
        return;
      }

      const resultDiv = document.getElementById("analysisResult");
      const output = document.getElementById("outputText");
      resultDiv.style.display = "block";
      output.innerText = "Reading PDF...";

      const pdfData = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

      let text = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str).join(" ");
        text += strings + "\n";

        if (!strings.trim()) {
          const viewport = page.getViewport({ scale: 2 });
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          await page.render({ canvasContext: context, viewport }).promise;
          const ocrResult = await Tesseract.recognize(canvas, 'eng');
          text += ocrResult.data.text + "\n";
        }
      }

      if (!text.trim()) {
        output.innerText = "Could not extract text from PDF.";
        return;
      }

      output.innerText = "Sending to GPT...";

      const prompt = `Analyze this contract:\n\n${text}`;

      try {
        const res = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${openaiKey}`
          },
          body: JSON.stringify({
            model: "gpt-4",
            messages: [{ role: "user", content: prompt }]
          })
        });

        const data = await res.json();
        output.innerText = data?.choices?.[0]?.message?.content || "No response.";
      } catch (e) {
        output.innerText = "Error: " + e.message;
      }
    });
  </script>
</body>
</html>
"""

# Save the full file
base_ui_path.write_text(ui_html.strip())

base_ui_path.name
